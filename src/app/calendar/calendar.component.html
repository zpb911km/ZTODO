<meta name="viewport" content="width=device-width, initial-scale=1.0">
<div class="calendar">
    <div class="calendar-header">
        <div style="display: flex; flex-wrap: wrap; gap: 6px; align-items: center;">
            <button (click)="addNewTask()">[+]</button>
            <button (click)="zoomIn()">(+)</button>
            <button (click)="zoomOut()">(-)</button>
            <button (click)="scrollToCurrentDate()">[|]</button>
            <button (click)="exportTasks()">save</button>
            <button (click)="importTasks()">load</button>
            <button (click)="toggleDarkMode()">{{ darkMode ? 'ğŸŒ‘' : 'ğŸŒ™' }}</button>
        </div>
        <br />
        <div style="display: flex; gap: 6px; align-items: center;">
            <span>{{ currentPrecision }}</span>
            |
            <span>{{ getFacingTime() }}</span>
        </div>
        
        <!-- <span></span>
        <span>{{ currentPrecision }}</span> -->
        <!-- <button (click)="importTasks()">å¯¼å…¥ä»»åŠ¡</button> -->
    </div>
    <div class="calendar-body" #calendarBody (scroll)="onScroll($event)" (wheel)="onWheel($event)">
        <div class="date-container">
            <div *ngFor="let date of dates; let i = index" class="date-cell" [style.width.px]="cellWidth"
            [style.backgroundColor]="i % 2 === 0 ? (darkMode ? 'darkgray' : 'white') : (darkMode ? 'gray' : 'lightgray')">
                {{ formatDate(date) }}
            </div>
        </div>
        <!-- å°æ–¹å—ä»»åŠ¡å®¹å™¨ -->
        <div class="indicator-container">
            <ng-container *ngFor="let task of tasks">
                <div *ngIf="getTaskPosition(task).isIndicator" class="task-indicator" 
                     [style.left.px]="getTaskPosition(task).left"
                     [style.top.px]="getTaskPosition(task).top"
                     [style.border]="'1px solid ' + getPriorityColor(task)"
                     [style.backgroundColor]="getTaskColor(task)"
                     [title]="task.title + ' (' + task.priority + '): ' + task.description"
                     (click)="openEditDialog(task)">
                </div>
            </ng-container>
        </div>

        <!-- æ¡å½¢ä»»åŠ¡å®¹å™¨ -->
        <div class="task-container" [style.height.px]="tasks.length * 30 + 40">
            <ng-container *ngFor="let task of tasks">
                <div *ngIf="!getTaskPosition(task).isIndicator" class="task-bar" 
                     [style.left.px]="getTaskPosition(task).left"
                     [style.width.px]="getTaskPosition(task).width"
                     [style.top.px]="getTaskPosition(task).top"
                     [style.border]="'2px solid ' + getPriorityColor(task)"
                     [style.backgroundColor]="getTaskColor(task)"
                     [title]="task.title + ' [' + task.priority + ']: ' + task.description"
                     (click)="openEditDialog(task)">
                    <div class="task-tag" *ngIf="getTaskTag(task)">{{ getTaskTag(task) }}</div>
                    <p class="task-title">{{task.title}}</p>
                    <div class="progress-bar-container" *ngIf="getTaskProgress(task) > 0">
                        <div class="progress-bar" [style.width.%]="getTaskProgress(task)"></div>
                    </div>
                </div>
            </ng-container>
        </div>
    </div>
</div>

<!-- ç¼–è¾‘å¼¹çª— -->
<div class="edit-dialog-overlay" *ngIf="editingTask">
    <!-- ä¸Šæ–¹é€æ˜åŒºåŸŸ -->
    <div class="overlay-top" (click)="closeDialog()"></div>
    <!-- å·¦ä¾§é€æ˜åŒºåŸŸ -->
    <div class="overlay-left" (click)="closeDialog()"></div>
    <!-- ç¼–è¾‘å¼¹çª—å†…å®¹ -->
    <div class="edit-dialog-content">
        <h3>ç¼–è¾‘ä»»åŠ¡</h3>
        <form (ngSubmit)="saveTask()">
            <div class="form-group">
                <label>æ ‡é¢˜</label>
                <input type="text" [(ngModel)]="editingTask.title" name="title" required>
            </div>
            <div class="form-group">
                <label>æè¿°</label>
                <textarea [(ngModel)]="editingTask.description" name="description" style="height: fit-content;"></textarea>
            </div>
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <select [(ngModel)]="editingTask.status" name="status">
                    <option value="todo">å¾…åŠ</option>
                    <option value="inProgress">è¿›è¡Œä¸­</option>
                    <option value="done">å·²å®Œæˆ</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div class="form-group">
                <label>ä¼˜å…ˆçº§</label>
                <input type="number" [(ngModel)]="editingTask.priority" name="priority" min="1">
            </div>
            <div class="form-group">
                <label>å¼€å§‹æ—¶é—´</label>
                <div class="datetime-inputs">
                    <input type="date" [value]="formatDateInput(editingTask.start)" 
                           (input)="updateDatePart('start', $event)">
                    <input type="time" [value]="formatTimeInput(editingTask.start)" 
                           (input)="updateTimePart('start', $event)">
                </div>
            </div>
            <div class="form-group">
                <label>ç»“æŸæ—¶é—´</label>
                <div class="datetime-inputs">
                    <input type="date" [value]="formatDateInput(editingTask.end)" 
                           (input)="updateDatePart('end', $event)">
                    <input type="time" [value]="formatTimeInput(editingTask.end)" 
                           (input)="updateTimePart('end', $event)">
                </div>
            </div>
            <div class="form-group">
                <label>å…¶ä»–å­—æ®µ</label>
                <div *ngFor="let item of editingTask.others; let i = index" class="other-item">
                    <input type="text" [(ngModel)]="item.key" [name]="'otherKey'+i" placeholder="å­—æ®µå">
                    <input type="text" [(ngModel)]="item.value" [name]="'otherValue'+i" placeholder="å€¼">
                    <button type="button" (click)="removeOtherField(i)">åˆ é™¤</button>
                </div>
                <button type="button" (click)="addOtherField()">æ·»åŠ å­—æ®µ</button>
            </div>
            <div class="dialog-actions">
                <button type="submit">ä¿å­˜</button>
                <button type="button" (click)="deleteTask()">åˆ é™¤</button>
                <button type="button" (click)="closeDialog()">å–æ¶ˆ</button>
            </div>
        </form>
    </div>
    <!-- å³ä¾§é€æ˜åŒºåŸŸ -->
    <div class="overlay-right" (click)="closeDialog()"></div>
    <!-- ä¸‹æ–¹é€æ˜åŒºåŸŸ -->
    <div class="overlay-bottom" (click)="closeDialog()"></div>
</div>
